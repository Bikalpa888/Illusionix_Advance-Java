<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shopping Cart & Checkout - Illusionix</title>
  <link rel="stylesheet" th:href="@{/main.css}" />

  <meta name="description" content="Complete your VR/AR purchase with secure checkout, setup services, and delivery options" />
  <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fvrcommerc3603back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="bg-background text-text-primary">
<!-- Live Chat Widget -->
<div id="live-chat-widget" class="fixed bottom-4 right-4 z-50">
  <button id="chat-toggle" class="bg-accent hover:bg-accent-600 text-white rounded-full p-4 shadow-lg transition-all duration-300">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
  </button>

  <!-- Chat Window -->
  <div id="chat-window" class="absolute bottom-16 right-0 w-80 h-96 bg-white rounded-lg shadow-xl border border-primary-200 transform scale-0 transition-transform duration-300 origin-bottom-right">
    <div class="bg-accent text-white p-4 rounded-t-lg flex justify-between items-center">
      <h3 class="font-semibold">Live Support</h3>
      <button id="chat-close" class="text-white hover:text-accent-200">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="chat-messages" class="p-4 h-64 overflow-y-auto">
      <div class="mb-3">
        <div class="bg-primary-50 p-3 rounded-lg max-w-xs">
          <p class="text-sm">Hello! How can I help you today?</p>
          <span class="text-xs text-text-secondary">Support Agent • Online</span>
        </div>
      </div>
    </div>
    <div class="p-4 border-t border-primary-200">
      <div class="flex space-x-2">
        <input type="text" id="chat-input" placeholder="Type your message..." class="flex-1 input-field text-sm py-2" />
        <button id="chat-send" class="btn-accent px-4 py-2 text-sm">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Navigation Header -->
<header class="bg-surface/80 backdrop-blur-md border-b border-primary-200 sticky top-0 z-50">
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <a href="homepage" class="flex items-center" th:href="@{/homepage}">
        <svg class="w-10 h-10 text-secondary" viewBox="0 0 40 40" fill="currentColor">
          <path d="M20 4L36 12v16L20 36L4 28V12L20 4z"/>
          <circle cx="20" cy="20" r="8" fill="white"/>
          <circle cx="20" cy="20" r="4" fill="currentColor"/>
        </svg>
        <span class="ml-3 text-xl font-bold text-primary">Illusionix</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-8">
        <a href="homepage" class="text-text-secondary hover:text-secondary transition-colors">Home</a>
        <a href="product_categories" class="text-text-secondary hover:text-secondary transition-colors">Products</a>
        <a href="virtual_showroom" class="text-text-secondary hover:text-secondary transition-colors">Virtual Showroom</a>
        <a href="user_dashboard" class="text-text-secondary hover:text-secondary transition-colors">Dashboard</a>

        <!-- Search Bar -->
        <div class="relative">
          <button id="search-toggle" class="text-text-secondary hover:text-secondary transition-colors p-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </button>
          <div id="search-expanded" class="absolute right-0 top-full mt-2 transform scale-0 transition-transform duration-300 origin-top-right">
            <div class="relative">
              <input type="text" id="search-input" placeholder="Search products..." class="input-field pl-10 pr-4 py-2 w-64 bg-white shadow-lg border border-primary-200" />
              <svg class="w-5 h-5 text-text-secondary absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>

              <!-- Search Results Dropdown -->
              <div id="search-results" class="absolute top-full left-0 right-0 bg-white shadow-lg rounded-lg mt-2 border border-primary-200 hidden max-h-64 overflow-y-auto">
                <!-- Search results will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <button class="theme-toggle text-text-secondary hover:text-secondary" aria-pressed="false" title="Switch theme">
            <svg data-icon="moon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 118.646 3.646 7 7 0 0020.354 15.354z"/></svg>
            <svg data-icon="sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364 6.364l-1.414-1.414M7.05 7.05 5.636 5.636m12.728 0-1.414 1.414M7.05 16.95l-1.414 1.414M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>
          </button>
          <a href="/shopping_cart_checkout" th:href="@{/shopping_cart_checkout}" class="relative text-secondary font-semibold">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"/>
            </svg>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-accent text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
          </a>

          <!-- Login and Signup Buttons -->
          <div class="flex items-center space-x-2 ml-4" th:if="${!loggedIn}">
            <a href="login" class="btn-secondary text-sm px-4 py-2">Login</a>
            <a href="signup" class="btn-accent text-sm px-4 py-2">Sign Up</a>
          </div>
          <div class="flex items-center space-x-2 ml-4" th:if="${loggedIn}">
            <span class="text-sm text-text-secondary">Hi, <span class="text-primary font-semibold" th:text="${currentUserName}">User</span></span>
            <a href="logout" class="btn-secondary text-sm px-4 py-2">Logout</a>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-btn" class="md:hidden text-text-secondary">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="md:hidden hidden py-4 border-t border-primary-200">
      <div class="flex flex-col space-y-4">
        <div class="relative mb-4">
          <input type="text" placeholder="Search products..." class="input-field pl-10 pr-4 py-2 w-full" />
          <svg class="w-5 h-5 text-text-secondary absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <a href="homepage" class="text-text-secondary">Home</a>
        <a href="product_categories" class="text-text-secondary">Products</a>
        <a href="virtual_showroom" class="text-text-secondary">Virtual Showroom</a>
        <a href="user_dashboard" class="text-text-secondary">Dashboard</a>
        <a href="aboutus" class="text-text-secondary">About</a>
        <a href="contact" class="text-text-secondary">Contact</a>

        <!-- Mobile Login and Signup Buttons -->
        <div class="flex flex-col space-y-2 pt-4 border-t border-primary-200">
          <div th:if="${!loggedIn}">
            <a href="login" class="btn-secondary text-center">Login</a>
            <a href="signup" class="btn-accent text-center">Sign Up</a>
          </div>
          <div th:if="${loggedIn}">
            <div class="text-sm text-text-secondary">Signed in as <span class="text-primary font-semibold" th:text="${currentUserName}">User</span></div>
            <a href="logout" class="btn-secondary text-center">Logout</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- Checkout Progress Indicator -->
<section class="bg-surface py-6">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <div class="flex items-center text-accent">
          <div class="w-8 h-8 bg-accent text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">1</div>
          <span class="font-semibold">Shopping Cart</span>
        </div>
        <svg class="w-5 h-5 mx-4 text-primary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
      <div class="flex items-center">
        <div class="flex items-center text-text-secondary">
          <div class="w-8 h-8 border-2 border-primary-300 text-primary-300 rounded-full flex items-center justify-center text-sm font-bold mr-3">2</div>
          <span>Checkout</span>
        </div>
        <svg class="w-5 h-5 mx-4 text-primary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
      <div class="flex items-center text-text-secondary">
        <div class="w-8 h-8 border-2 border-primary-300 text-primary-300 rounded-full flex items-center justify-center text-sm font-bold mr-3">3</div>
        <span>Confirmation</span>
      </div>
    </div>
  </div>
</section>
<script th:inline="javascript">
  // Merge server cart into client cart (non-destructive)
  window.__serverCart = /*[[${serverCartJson}]]*/ '{}';
  (function(){
    try {
      const server = JSON.parse(window.__serverCart || '{}');
      const items = Array.isArray(server.items) ? server.items : [];
      const KEY='illusionix_cart';
      const cur = JSON.parse(localStorage.getItem(KEY)||'{"items":[]}');
      const index = new Map((cur.items||[]).map(it=>[String(it.id||it.productSku||it.sku||it.name), it]));
      items.forEach(ci=>{
        const id = String(ci.productSku||ci.sku||ci.name);
        if(!index.has(id)){
          (cur.items = cur.items || []).push({
            id: id,
            name: ci.name,
            price: Number(ci.price||0),
            image: ci.image||'',
            qty: Number(ci.quantity||1)
          });
        }
      });
      localStorage.setItem(KEY, JSON.stringify(cur));
    } catch(e) {}
  })();
  (function(){
    const KEY='illusionix_cart';
    function read(){try{return JSON.parse(localStorage.getItem(KEY)||'{"items":[]}');}catch(_){return {items:[]};}}
    function write(c){try{localStorage.setItem(KEY, JSON.stringify(c));}catch(_){}}
    function total(){return read().items.reduce((s,it)=>s+(it.qty||0),0);}
    function updateBadges(){document.querySelectorAll('#cart-count,[data-cart-count]').forEach(el=>el.textContent=String(total()));}
    if(!('Cart' in window)){
      window.Cart={
        add({id,name,price,image,qty=1}){const c=read();const k=String(id);const ex=c.items.find(it=>String(it.id)===k);if(ex){ex.qty+=qty;}else{c.items.push({id:k,name,price:Number(price||0),image:image||'',qty});}write(c);updateBadges();return c;},
        get(){return read();},clear(){write({items:[]});updateBadges();}
      };
    }
    document.addEventListener('click',function(e){const btn=e.target.closest('[data-add-to-cart]');if(!btn)return;Cart.add({id:btn.getAttribute('data-id'),name:btn.getAttribute('data-name'),price:Number(btn.getAttribute('data-price')||0),image:btn.getAttribute('data-image')||'',qty:1});btn.classList.add('ring-2','ring-accent');setTimeout(()=>btn.classList.remove('ring-2','ring-accent'),400);});
    if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',updateBadges);}else{updateBadges();}
  })();
</script>

<!-- Main Content -->
<main class="py-12 bg-background">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid lg:grid-cols-3 gap-12">
      <!-- Cart Items Section -->
      <div class="lg:col-span-2">
        <div class="flex items-center justify-between mb-8">
          <h1 class="text-3xl font-bold text-primary">Shopping Cart</h1>
          <div class="flex items-center space-x-4">
            <span class="text-text-secondary">3 items</span>
            <button id="clear-cart" class="text-error hover:text-error-600 text-sm font-medium">Clear Cart</button>
          </div>
        </div>

        <!-- Cart Items -->
        <div class="space-y-6" id="cart-items">
          <!-- Server-rendered cart items -->
          <th:block th:if="${serverCart} != null and ${serverCart.items} != null and ${#lists.isEmpty(serverCart.items)} == false">
            <div class="card" th:each="ci : ${serverCart.items}" th:attr="data-product-id=${ci.productSku}">
              <div class="flex flex-col md:flex-row gap-6">
                <div class="relative w-full md:w-32 h-32 bg-gradient-to-br from-secondary-100 to-secondary-200 rounded-xl overflow-hidden">
                  <img th:src="${ci.image}" alt="item" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300" />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end justify-center p-2">
                    <button class="text-white text-xs bg-black/50 px-2 py-1 rounded">360° View</button>
                  </div>
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-start mb-4">
                    <div>
                      <h3 class="text-lg font-semibold text-primary mb-1" th:text="${ci.name}">Product</h3>
                      <p class="text-text-secondary text-sm mb-2" th:text="${ci.productSku}">SKU</p>
                      <div class="flex items-center space-x-4 text-sm">
                        <span class="text-success font-medium">✓ In Stock</span>
                        <span class="text-text-secondary" th:text="'SKU: ' + ${ci.productSku}">SKU:</span>
                      </div>
                    </div>
                    <button class="remove-item text-text-secondary hover:text-error transition-colors" th:attr="data-product-id=${ci.productSku}">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                  </div>
                  <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                      <span class="text-sm text-text-secondary">Qty:</span>
                      <div class="flex items-center border border-primary-200 rounded-lg">
                        <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="decrease" th:attr="data-product-id=${ci.productSku}">-</button>
                        <span class="quantity-display px-3 py-1 border-x border-primary-200" th:text="${ci.quantity}">1</span>
                        <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="increase" th:attr="data-product-id=${ci.productSku}">+</button>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-lg font-bold text-primary item-total" th:text="${#numbers.formatDecimal(ci.price * ci.quantity, 1, 'COMMA', 2, 'POINT')}">$0.00</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </th:block>
          <!-- Demo items (shown only if server cart is empty) -->
          <th:block th:if="${serverCart} == null or ${serverCart.items} == null or ${#lists.isEmpty(serverCart.items)}">
          <!-- Cart Item 1 -->
          <div class="card" data-product-id="quest3">
            <div class="flex flex-col md:flex-row gap-6">
              <!-- Enhanced 360° Product Thumbnail -->
              <div class="relative w-full md:w-32 h-32 bg-gradient-to-br from-secondary-100 to-secondary-200 rounded-xl overflow-hidden">
                <img src="https://images.unsplash.com/photo-1593508512255-86ab42a8e620?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Meta Quest 3" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300" loading="lazy" onerror="this.src='https://images.pixabay.com/photo/2017/05/13/12/40/fashion-2309519_1280.jpg'; this.onerror=null;" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end justify-center p-2">
                  <button class="text-white text-xs bg-black/50 px-2 py-1 rounded">360° View</button>
                </div>
              </div>

              <!-- Product Details -->
              <div class="flex-1">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="text-lg font-semibold text-primary mb-1">Meta Quest 3</h3>
                    <p class="text-text-secondary text-sm mb-2">128GB - White</p>
                    <div class="flex items-center space-x-4 text-sm">
                      <span class="text-success font-medium">✓ In Stock</span>
                      <span class="text-text-secondary">SKU: MQ3-128-WH</span>
                    </div>

                    <!-- Quick Actions -->
                    <div class="flex items-center space-x-4 mt-3">
                      <button class="text-accent hover:text-accent-600 text-sm font-medium">Move to Wishlist</button>
                      <button class="text-text-secondary hover:text-primary text-sm">Compare</button>
                      <button class="text-text-secondary hover:text-primary text-sm">Share</button>
                    </div>
                  </div>
                  <button class="remove-item text-text-secondary hover:text-error transition-colors" data-product-id="quest3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>
                </div>

                <!-- Configuration Summary -->
                <div class="bg-primary-50 rounded-lg p-3 mb-4">
                  <h4 class="text-sm font-semibold text-primary mb-2">Your Configuration</h4>
                  <div class="grid grid-cols-2 gap-2 text-xs text-text-secondary">
                    <span>Storage: 128GB</span>
                    <span>Color: White</span>
                    <span>Warranty: 2 Years Extended</span>
                    <span>Setup: Professional</span>
                  </div>
                </div>

                <!-- Quantity and Price -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <span class="text-sm text-text-secondary">Qty:</span>
                    <div class="flex items-center border border-primary-200 rounded-lg">
                      <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="decrease" data-product-id="quest3">-</button>
                      <span class="quantity-display px-3 py-1 border-x border-primary-200">1</span>
                      <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="increase" data-product-id="quest3">+</button>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold text-primary item-total">$499.00</div>
                    <div class="text-sm text-text-secondary line-through">$549.00</div>
                    <div class="text-xs text-success font-medium">Save $50</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cart Item 2 -->
          <div class="card" data-product-id="controllers">
            <div class="flex flex-col md:flex-row gap-6">
              <!-- Enhanced 360° Product Thumbnail -->
              <div class="relative w-full md:w-32 h-32 bg-gradient-to-br from-accent-100 to-accent-200 rounded-xl overflow-hidden">
                <img src="https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="VR Controller Set" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300" loading="lazy" onerror="this.src='https://images.pixabay.com/photo/2017/05/13/12/40/fashion-2309519_1280.jpg'; this.onerror=null;" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end justify-center p-2">
                  <button class="text-white text-xs bg-black/50 px-2 py-1 rounded">360° View</button>
                </div>
              </div>

              <!-- Product Details -->
              <div class="flex-1">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="text-lg font-semibold text-primary mb-1">VR Controller Set</h3>
                    <p class="text-text-secondary text-sm mb-2">Precision Hand Tracking - Pair</p>
                    <div class="flex items-center space-x-4 text-sm">
                      <span class="text-success font-medium">✓ In Stock</span>
                      <span class="text-text-secondary">SKU: VRC-PRO-BK</span>
                    </div>

                    <!-- Quick Actions -->
                    <div class="flex items-center space-x-4 mt-3">
                      <button class="text-accent hover:text-accent-600 text-sm font-medium">Move to Wishlist</button>
                      <button class="text-text-secondary hover:text-primary text-sm">Compare</button>
                      <button class="text-text-secondary hover:text-primary text-sm">Share</button>
                    </div>
                  </div>
                  <button class="remove-item text-text-secondary hover:text-error transition-colors" data-product-id="controllers">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>
                </div>

                <!-- Quantity and Price -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <span class="text-sm text-text-secondary">Qty:</span>
                    <div class="flex items-center border border-primary-200 rounded-lg">
                      <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="decrease" data-product-id="controllers">-</button>
                      <span class="quantity-display px-3 py-1 border-x border-primary-200">1</span>
                      <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="increase" data-product-id="controllers">+</button>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold text-primary item-total">$149.00</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cart Item 3 -->
          <div class="card" data-product-id="case">
            <div class="flex flex-col md:flex-row gap-6">
              <!-- Enhanced 360° Product Thumbnail -->
              <div class="relative w-full md:w-32 h-32 bg-gradient-to-br from-success-100 to-success-200 rounded-xl overflow-hidden">
                <img src="https://images.pexels.com/photos/3183150/pexels-photo-3183150.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" alt="VR Protective Case" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?q=80&w=2926&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end justify-center p-2">
                  <button class="text-white text-xs bg-black/50 px-2 py-1 rounded">360° View</button>
                </div>
              </div>

              <!-- Product Details -->
              <div class="flex-1">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="text-lg font-semibold text-primary mb-1">VR Protective Case</h3>
                    <p class="text-text-secondary text-sm mb-2">Premium Travel Case - Black</p>
                    <div class="flex items-center space-x-4 text-sm">
                      <span class="text-success font-medium">✓ In Stock</span>
                      <span class="text-text-secondary">SKU: VRC-CASE-BK</span>
                    </div>

                    <!-- Quick Actions -->
                    <div class="flex items-center space-x-4 mt-3">
                      <button class="text-accent hover:text-accent-600 text-sm font-medium">Move to Wishlist</button>
                      <button class="text-text-secondary hover:text-primary text-sm">Compare</button>
                      <button class="text-text-secondary hover:text-primary text-sm">Share</button>
                    </div>
                  </div>
                  <button class="remove-item text-text-secondary hover:text-error transition-colors" data-product-id="case">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>
                </div>

                <!-- Quantity and Price -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <span class="text-sm text-text-secondary">Qty:</span>
                    <div class="flex items-center border border-primary-200 rounded-lg">
                      <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="decrease" data-product-id="case">-</button>
                      <span class="quantity-display px-3 py-1 border-x border-primary-200">1</span>
                      <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="increase" data-product-id="case">+</button>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold text-primary item-total">$79.00</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </th:block>
        </div>

        <!-- Smart Recommendations -->
        <div class="mt-12">
          <h2 class="text-2xl font-bold text-primary mb-6">Complete Your VR Setup</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Recommendation 1 -->
            <div class="card group cursor-pointer hover:scale-105 transition-all duration-300">
              <div class="flex items-center space-x-4">
                <div class="w-16 h-16 bg-gradient-to-br from-warning-100 to-warning-200 rounded-lg overflow-hidden">
                  <img src="https://images.pixabay.com/photo/2021/08/04/13/06/software-developer-6521720_1280.jpg" alt="VR Stand" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?q=80&w=2926&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;" />
                </div>
                <div class="flex-1">
                  <h3 class="font-semibold text-primary">VR Headset Stand</h3>
                  <p class="text-sm text-text-secondary">Premium display & charging dock</p>
                  <div class="flex items-center justify-between mt-2">
                    <span class="text-lg font-bold text-primary">$39.00</span>
                    <button class="btn-accent text-sm px-4 py-1 add-to-cart" data-product="{&quot;id&quot;:&quot;stand&quot;,&quot;name&quot;:&quot;VR Headset Stand&quot;,&quot;price&quot;:39}">Add to Cart</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recommendation 2 -->
            <div class="card group cursor-pointer hover:scale-105 transition-all duration-300">
              <div class="flex items-center space-x-4">
                <div class="w-16 h-16 bg-gradient-to-br from-secondary-100 to-secondary-200 rounded-lg overflow-hidden">
                  <img src="https://images.pexels.com/photos/3761264/pexels-photo-3761264.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" alt="VR Games Bundle" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1593508512255-86ab42a8e620?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;" />
                </div>
                <div class="flex-1">
                  <h3 class="font-semibold text-primary">VR Games Bundle</h3>
                  <p class="text-sm text-text-secondary">5 premium games included</p>
                  <div class="flex items-center justify-between mt-2">
                    <span class="text-lg font-bold text-primary">$99.00</span>
                    <button class="btn-accent text-sm px-4 py-1 add-to-cart" data-product="{&quot;id&quot;:&quot;games&quot;,&quot;name&quot;:&quot;VR Games Bundle&quot;,&quot;price&quot;:99}">Add to Cart</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Checkout Sidebar -->
      <div class="lg:col-span-1">
        <div class="sticky top-24">
          <!-- Order Summary -->
          <div class="card mb-6">
            <h2 class="text-xl font-bold text-primary mb-6">Order Summary</h2>

            <div class="space-y-4 mb-6">
              <div class="flex justify-between">
                <span class="text-text-secondary" id="subtotal-label">Subtotal (0 items)</span>
                <span class="text-primary" id="subtotal">$727.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-secondary">Shipping</span>
                <span class="text-success">Free</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-secondary">Tax</span>
                <span class="text-primary" id="tax">$58.16</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-secondary">Discount</span>
                <span class="text-success" id="discount">-$50.00</span>
              </div>
              <div class="border-t border-primary-200 pt-4">
                <div class="flex justify-between items-center">
                  <span class="text-lg font-bold text-primary">Total</span>
                  <span class="text-2xl font-bold text-primary" id="total">$735.16</span>
                </div>
              </div>
            </div>

            <!-- Enhanced Promo Code -->
            <div class="mb-6">
              <div class="flex space-x-2 mb-2">
                <input type="text" id="promo-code" placeholder="Enter promo code" class="input-field flex-1" />
                <button id="apply-promo" class="btn-secondary">Apply</button>
              </div>
              <div class="text-xs text-text-secondary">
                Try: NEWUSER (10% off), VR2025 (Free shipping)
              </div>
            </div>

            <!-- Setup Services -->
            <div class="mb-6">
              <h3 class="font-semibold text-primary mb-4">Setup Services</h3>
              <div class="space-y-3">
                <label class="flex items-start">
                  <input type="checkbox" class="service-checkbox mr-3 mt-1 text-secondary" data-price="99" checked />
                  <div class="flex-1">
                    <span class="text-sm font-medium text-primary">Professional Setup</span>
                    <p class="text-xs text-text-secondary">Technician installation & configuration</p>
                    <p class="text-xs text-accent font-medium">Includes: Room setup, calibration, training</p>
                  </div>
                  <span class="text-sm font-bold text-primary">$99</span>
                </label>
                <label class="flex items-start">
                  <input type="checkbox" class="service-checkbox mr-3 mt-1 text-secondary" data-price="149" />
                  <div class="flex-1">
                    <span class="text-sm font-medium text-primary">Extended Warranty</span>
                    <p class="text-xs text-text-secondary">3-year comprehensive coverage</p>
                    <p class="text-xs text-accent font-medium">Includes: Repairs, replacements, support</p>
                  </div>
                  <span class="text-sm font-bold text-primary">$149</span>
                </label>
                <label class="flex items-start">
                  <input type="checkbox" class="service-checkbox mr-3 mt-1 text-secondary" data-price="49" />
                  <div class="flex-1">
                    <span class="text-sm font-medium text-primary">Data Transfer Service</span>
                    <p class="text-xs text-text-secondary">Transfer from old VR device</p>
                    <p class="text-xs text-accent font-medium">Includes: Games, settings, profiles</p>
                  </div>
                  <span class="text-sm font-bold text-primary">$49</span>
                </label>
              </div>
            </div>

            <!-- Delivery Options -->
            <div class="mb-6">
              <h3 class="font-semibold text-primary mb-4">Delivery Options</h3>
              <div class="space-y-3">
                <label class="flex items-center p-3 border border-accent bg-accent-50 rounded-lg cursor-pointer">
                  <input type="radio" name="delivery" class="mr-3 text-secondary" checked />
                  <div class="flex-1">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-primary">Standard Delivery</span>
                      <span class="text-sm font-bold text-success">Free</span>
                    </div>
                    <p class="text-xs text-text-secondary">5-7 business days • Contactless delivery</p>
                    <p class="text-xs text-accent">✓ Tracking included • ✓ Insurance covered</p>
                  </div>
                </label>
                <label class="flex items-center p-3 border border-primary-200 rounded-lg cursor-pointer hover:bg-primary-50">
                  <input type="radio" name="delivery" class="mr-3 text-secondary" />
                  <div class="flex-1">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-primary">Express Delivery</span>
                      <span class="text-sm font-bold text-primary">$29</span>
                    </div>
                    <p class="text-xs text-text-secondary">2-3 business days • Priority handling</p>
                    <p class="text-xs text-accent">✓ Premium packaging • ✓ SMS updates</p>
                  </div>
                </label>
                <label class="flex items-center p-3 border border-primary-200 rounded-lg cursor-pointer hover:bg-primary-50">
                  <input type="radio" name="delivery" class="mr-3 text-secondary" />
                  <div class="flex-1">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-primary">White-Glove Installation</span>
                      <span class="text-sm font-bold text-primary">$199</span>
                    </div>
                    <p class="text-xs text-text-secondary">Same day • Setup & training included</p>
                    <p class="text-xs text-accent">✓ Professional tech • ✓ 2-hour session</p>
                  </div>
                </label>
              </div>
            </div>

            <!-- Checkout Button -->
            <button id="checkout-btn" class="w-full btn-accent text-lg py-4 mb-4">
              Proceed to Secure Checkout
              <svg class="w-5 h-5 ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>

            <!-- Security Badges -->
            <div class="text-center mb-6">
              <div class="flex justify-center items-center space-x-4 mb-3">
                <div class="flex items-center text-xs text-text-secondary">
                  <svg class="w-4 h-4 text-success mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                  </svg>
                  SSL Secured
                </div>
                <div class="flex items-center text-xs text-text-secondary">
                  <svg class="w-4 h-4 text-success mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.031 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                  </svg>
                  Protected
                </div>
                <div class="flex items-center text-xs text-text-secondary">
                  <svg class="w-4 h-4 text-success mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  Money Back
                </div>
              </div>
              <p class="text-xs text-text-secondary">Your payment information is secure and encrypted</p>
            </div>
          </div>

          <!-- Special Financing -->
          <div class="card">
            <div class="flex items-center mb-4">
              <svg class="w-6 h-6 text-accent mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
              </svg>
              <h3 class="font-semibold text-primary">Flexible Payment Options</h3>
            </div>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm text-text-secondary">0% APR for 12 months</span>
                <span class="text-sm text-primary font-semibold">$61.26/mo</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-text-secondary">Buy now, pay in 4</span>
                <span class="text-sm text-primary font-semibold">$183.79/mo</span>
              </div>
            </div>
            <button class="text-accent text-sm font-semibold hover:text-accent-600 transition-colors mt-4 block">
              Learn More →
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Enhanced Payment Modal -->
<div id="payment-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-primary-200">
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-primary">Secure Checkout</h2>
        <button id="close-payment-modal" class="text-text-secondary hover:text-primary">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="p-6">
      <div class="grid md:grid-cols-2 gap-8">
        <!-- Payment Methods -->
        <div>
          <h3 class="text-lg font-semibold text-primary mb-4">Payment Method</h3>

          <!-- Payment Method Tabs -->
          <div class="flex space-x-2 mb-6">
            <button class="payment-tab active px-4 py-2 rounded-lg border-2 border-accent bg-accent-50 text-accent font-medium text-sm" data-method="card">
              Credit Card
            </button>
            <button class="payment-tab px-4 py-2 rounded-lg border-2 border-primary-200 text-text-secondary font-medium text-sm" data-method="esewa">
              eSewa
            </button>
            <button class="payment-tab px-4 py-2 rounded-lg border-2 border-primary-200 text-text-secondary font-medium text-sm" data-method="khalti">
              Khalti
            </button>
            <button class="payment-tab px-4 py-2 rounded-lg border-2 border-primary-200 text-text-secondary font-medium text-sm" data-method="cod">
              Cash on Delivery
            </button>
          </div>

          <!-- Credit Card Form -->
          <div id="card-form" class="payment-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-primary mb-2">Card Number</label>
                <div class="relative">
                  <input type="text" placeholder="1234 5678 9012 3456" class="input-field w-full pl-12" id="card-number" maxlength="19" />
                  <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                    <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-primary mb-2">Expiry Date</label>
                  <input type="text" placeholder="MM/YY" class="input-field w-full" id="expiry" maxlength="5" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-primary mb-2">CVV</label>
                  <input type="text" placeholder="123" class="input-field w-full" id="cvv" maxlength="4" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-primary mb-2">Cardholder Name</label>
                <input type="text" placeholder="John Doe" class="input-field w-full" id="cardholder-name" />
              </div>
            </div>
          </div>

          <!-- eSewa Form -->
          <div id="esewa-form" class="payment-form hidden">
            <div class="text-center py-8">
              <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <h4 class="text-lg font-semibold text-primary mb-2">Pay with eSewa</h4>
              <p class="text-text-secondary text-sm mb-4">You'll be redirected to eSewa to complete your payment securely.</p>
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <p class="text-sm text-green-800">✓ Instant payment processing</p>
                <p class="text-sm text-green-800">✓ No additional fees</p>
                <p class="text-sm text-green-800">✓ Secure authentication</p>
              </div>
            </div>
          </div>

          <!-- Khalti Form -->
          <div id="khalti-form" class="payment-form hidden">
            <div class="text-center py-8">
              <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-purple-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <h4 class="text-lg font-semibold text-primary mb-2">Pay with Khalti</h4>
              <p class="text-text-secondary text-sm mb-4">You'll be redirected to Khalti to complete your payment securely.</p>
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <p class="text-sm text-purple-800">✓ Mobile wallet payment</p>
                <p class="text-sm text-purple-800">✓ Quick authentication</p>
                <p class="text-sm text-purple-800">✓ Reward points eligible</p>
              </div>
            </div>
          </div>

          <!-- Cash on Delivery Form -->
          <div id="cod-form" class="payment-form hidden">
            <div class="text-center py-8">
              <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
              </div>
              <h4 class="text-lg font-semibold text-primary mb-2">Cash on Delivery</h4>
              <p class="text-text-secondary text-sm mb-4">Pay with cash when your order arrives at your doorstep.</p>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-800">✓ No advance payment required</p>
                <p class="text-sm text-blue-800">✓ Inspect before payment</p>
                <p class="text-sm text-blue-800">✓ Additional COD fee: $5</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Billing & Shipping Information -->
        <div>
          <h3 class="text-lg font-semibold text-primary mb-4">Billing Information</h3>

          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-primary mb-2">First Name</label>
                <input type="text" placeholder="John" class="input-field w-full" id="first-name" required />
              </div>
              <div>
                <label class="block text-sm font-semibold text-primary mb-2">Last Name</label>
                <input type="text" placeholder="Doe" class="input-field w-full" id="last-name" required />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-primary mb-2">Email Address</label>
              <input type="email" placeholder="john.doe@example.com" class="input-field w-full" id="email" required />
            </div>

            <div>
              <label class="block text-sm font-semibold text-primary mb-2">Phone Number</label>
              <input type="tel" placeholder="+1 (555) 123-4567" class="input-field w-full" id="phone" required />
            </div>

            <div>
              <label class="block text-sm font-semibold text-primary mb-2">Address</label>
              <input type="text" placeholder="123 Main Street" class="input-field w-full" id="address" required />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-primary mb-2">City</label>
                <input type="text" placeholder="San Francisco" class="input-field w-full" id="city" required />
              </div>
              <div>
                <label class="block text-sm font-semibold text-primary mb-2">ZIP Code</label>
                <input type="text" placeholder="94101" class="input-field w-full" id="zip" required />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-primary mb-2">State/Province</label>
              <select class="input-field w-full" id="state" required>
                <option value="">Select District</option>
                <option value="Achham">Achham</option>
                <option value="Arghakhanchi">Arghakhanchi</option>
                <option value="Baglung">Baglung</option>
                <option value="Baitadi">Baitadi</option>
                <option value="Bajhang">Bajhang</option>
                <option value="Bajura">Bajura</option>
                <option value="Banke">Banke</option>
                <option value="Bara">Bara</option>
                <option value="Bardiya">Bardiya</option>
                <option value="Bhaktapur">Bhaktapur</option>
                <option value="Bhojpur">Bhojpur</option>
                <option value="Chitwan">Chitwan</option>
                <option value="Dadeldhura">Dadeldhura</option>
                <option value="Dailekh">Dailekh</option>
                <option value="Dang">Dang</option>
                <option value="Darchula">Darchula</option>
                <option value="Dhading">Dhading</option>
                <option value="Dhankuta">Dhankuta</option>
                <option value="Dhanusa">Dhanusa</option>
                <option value="Dolakha">Dolakha</option>
                <option value="Dolpa">Dolpa</option>
                <option value="Doti">Doti</option>
                <option value="Eastern Rukum">Eastern Rukum</option>
                <option value="Gorkha">Gorkha</option>
                <option value="Gulmi">Gulmi</option>
                <option value="Humla">Humla</option>
                <option value="Ilam">Ilam</option>
                <option value="Jajarkot">Jajarkot</option>
                <option value="Jhapa">Jhapa</option>
                <option value="Jumla">Jumla</option>
                <option value="Kailali">Kailali</option>
                <option value="Kalikot">Kalikot</option>
                <option value="Kanchanpur">Kanchanpur</option>
                <option value="Kapilvastu">Kapilvastu</option>
                <option value="Kaski">Kaski</option>
                <option value="Kathmandu">Kathmandu</option>
                <option value="Kavrepalanchok">Kavrepalanchok</option>
                <option value="Khotang">Khotang</option>
                <option value="Lalitpur">Lalitpur</option>
                <option value="Lamjung">Lamjung</option>
                <option value="Mahottari">Mahottari</option>
                <option value="Makwanpur">Makwanpur</option>
                <option value="Manang">Manang</option>
                <option value="Morang">Morang</option>
                <option value="Mugu">Mugu</option>
                <option value="Mustang">Mustang</option>
                <option value="Myagdi">Myagdi</option>
                <option value="Nawalpur">Nawalpur</option>
                <option value="Nuwakot">Nuwakot</option>
                <option value="Okhaldhunga">Okhaldhunga</option>
                <option value="Palpa">Palpa</option>
                <option value="Panchthar">Panchthar</option>
                <option value="Parasi">Parasi</option>
                <option value="Parbat">Parbat</option>
                <option value="Parsa">Parsa</option>
                <option value="Pyuthan">Pyuthan</option>
                <option value="Ramechhap">Ramechhap</option>
                <option value="Rasuwa">Rasuwa</option>
                <option value="Rautahat">Rautahat</option>
                <option value="Rolpa">Rolpa</option>
                <option value="Rupandehi">Rupandehi</option>
                <option value="Salyan">Salyan</option>
                <option value="Sankhuwasabha">Sankhuwasabha</option>
                <option value="Saptari">Saptari</option>
                <option value="Sarlahi">Sarlahi</option>
                <option value="Sindhuli">Sindhuli</option>
                <option value="Sindhupalchok">Sindhupalchok</option>
                <option value="Siraha">Siraha</option>
                <option value="Solukhumbu">Solukhumbu</option>
                <option value="Sunsari">Sunsari</option>
                <option value="Surkhet">Surkhet</option>
                <option value="Syangja">Syangja</option>
                <option value="Tanahun">Tanahun</option>
                <option value="Taplejung">Taplejung</option>
                <option value="Terhathum">Terhathum</option>
                <option value="Udayapur">Udayapur</option>
                <option value="Western Rukum">Western Rukum</option>
              </select>
            </div>
          </div>

          <!-- Same as Billing Checkbox -->
          <div class="mt-6">
            <label class="flex items-center">
              <input type="checkbox" class="mr-3 text-accent" id="same-as-billing" checked />
              <span class="text-sm text-primary">Shipping address is the same as billing address</span>
            </label>
          </div>

          <!-- Order Summary in Modal -->
          <div class="mt-8 bg-primary-50 rounded-lg p-4">
            <h4 class="font-semibold text-primary mb-3">Order Total</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-text-secondary">Items (3)</span>
                <span class="text-primary">$727.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-secondary">Services</span>
                <span class="text-primary">$99.00</span>
              </div>
              <div class="flex justify-between">
                <span class="text-text-secondary">Tax</span>
                <span class="text-primary">$66.08</span>
              </div>
              <div class="border-t border-primary-200 pt-2 mt-2">
                <div class="flex justify-between font-bold">
                  <span class="text-primary">Total</span>
                  <span class="text-primary">$892.08</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Place Order Button -->
      <div class="mt-8 text-center">
        <button id="place-order-btn" class="btn-accent text-lg px-12 py-4">
          Place Order - $892.08
        </button>
        <p class="text-xs text-text-secondary mt-3">
          By placing your order, you agree to our
          <a href="#" class="text-accent hover:underline">Terms of Service</a> and
          <a href="#" class="text-accent hover:underline">Privacy Policy</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Order Confirmation Modal -->
<div id="confirmation-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-2xl w-full p-8 text-center">
    <div class="w-20 h-20 bg-success rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
    </div>

    <h2 class="text-3xl font-bold text-primary mb-4">Order Confirmed!</h2>
    <p class="text-text-secondary mb-6">Thank you for your purchase. Your VR journey begins now!</p>

    <div class="bg-primary-50 rounded-lg p-6 mb-6">
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-text-secondary">Order Number:</span>
          <span class="text-primary font-semibold block">#VR2025-001</span>
        </div>
        <div>
          <span class="text-text-secondary">Estimated Delivery:</span>
          <span class="text-primary font-semibold block">Jan 3-5, 2025</span>
        </div>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <button onclick="window.location.href='user_dashboard'" class="btn-accent">
        Track Your Order
      </button>
      <button onclick="window.location.href='homepage'" class="btn-secondary">
        Continue Shopping
      </button>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="bg-primary-900 text-white py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
      <!-- Company Info -->
      <div>
      <div class="flex items-center mb-6">
          <a href="homepage" th:href="@{/homepage}" class="inline-flex items-center group">
            <svg class="w-8 h-8 text-accent" viewBox="0 0 40 40" fill="currentColor"><path d="M20 4L36 12v16L20 36L4 28V12L20 4z"/><circle cx="20" cy="20" r="8" fill="white"/><circle cx="20" cy="20" r="4" fill="currentColor"/></svg>
            <span class="ml-3 text-xl font-bold group-hover:text-accent transition-colors">Illusionix</span>
          </a>
        </div>
        <p class="text-primary-300 mb-6">
          The future of shopping, today. Experience products before you buy with cutting-edge AR/VR technology.
        </p>
        <div class="flex space-x-4">
          <a href="javascript:void(0)" class="text-primary-400 hover:text-accent transition-colors">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/>
            </svg>
          </a>
          <a href="javascript:void(0)" class="text-primary-400 hover:text-accent transition-colors">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/>
            </svg>
          </a>
          <a href="javascript:void(0)" class="text-primary-400 hover:text-accent transition-colors">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Products -->
      <div>
        <h3 class="text-lg font-semibold mb-6">Products</h3>
        <ul class="space-y-3">
          <li><a href="product_categories" class="text-primary-300 hover:text-accent transition-colors">VR Headsets</a></li>
          <li><a href="product_categories" class="text-primary-300 hover:text-accent transition-colors">AR Glasses</a></li>
          <li><a href="product_categories" class="text-primary-300 hover:text-accent transition-colors">Accessories</a></li>
          <li><a href="product_categories" class="text-primary-300 hover:text-accent transition-colors">Enterprise Solutions</a></li>
        </ul>
      </div>

      <!-- Support -->
      <div>
        <h3 class="text-lg font-semibold mb-6">Support</h3>
        <ul class="space-y-3">
          <li><a href="javascript:void(0)" class="text-primary-300 hover:text-accent transition-colors">Setup Guides</a></li>
          <li><a href="javascript:void(0)" class="text-primary-300 hover:text-accent transition-colors">Troubleshooting</a></li>
          <li><a href="javascript:void(0)" class="text-primary-300 hover:text-accent transition-colors">Warranty</a></li>
          <li><a href="contact" class="text-primary-300 hover:text-accent transition-colors">Contact Us</a></li>
        </ul>
      </div>

      <!-- Company -->
      <div>
        <h3 class="text-lg font-semibold mb-6">Company</h3>
        <ul class="space-y-3">
          <li><a href="aboutus" class="text-primary-300 hover:text-accent transition-colors">About Us</a></li>
          <li><a href="javascript:void(0)" class="text-primary-300 hover:text-accent transition-colors">Careers</a></li>
          <li><a href="javascript:void(0)" class="text-primary-300 hover:text-accent transition-colors">Press</a></li>
          <li><a href="javascript:void(0)" class="text-primary-300 hover:text-accent transition-colors">Partners</a></li>
        </ul>
      </div>
    </div>

    <div class="border-t border-primary-700 pt-8 flex flex-col md:flex-row justify-between items-center">
      <p class="text-primary-400 text-sm">
        © 2025 Illusionix. All Rights Reserved.
      </p>
      <div class="flex space-x-6 mt-4 md:mt-0">
        <a href="javascript:void(0)" class="text-primary-400 hover:text-accent text-sm transition-colors">Privacy Policy</a>
        <a href="javascript:void(0)" class="text-primary-400 hover:text-accent text-sm transition-colors">Terms of Service</a>
        <a href="javascript:void(0)" class="text-primary-400 hover:text-accent text-sm transition-colors">Cookie Policy</a>
      </div>
    </div>
  </div>
</footer>

<!-- Enhanced JavaScript Functionality -->
<script>
  // XSRF helper available globally
  function xsrf(){ try{ return document.cookie.split('; ').find(r=>r.startsWith('XSRF-TOKEN='))?.split('=')[1]||'';}catch(_){return '';} }
  // Mobile menu toggle
  document.getElementById('mobile-menu-btn')?.addEventListener('click', function() {
      document.getElementById('mobile-menu')?.classList.toggle('hidden');
  });

  // Search functionality
  document.addEventListener('DOMContentLoaded', function() {
      const searchToggle = document.getElementById('search-toggle');
      const searchExpanded = document.getElementById('search-expanded');
      const searchInput = document.getElementById('search-input');

      if (searchToggle && searchExpanded) {
          searchToggle.addEventListener('click', function() {
              const isExpanded = searchExpanded.classList.contains('scale-100');
              if (isExpanded) {
                  searchExpanded.classList.remove('scale-100');
                  searchExpanded.classList.add('scale-0');
              } else {
                  searchExpanded.classList.remove('scale-0');
                  searchExpanded.classList.add('scale-100');
                  searchInput.focus();
              }
          });

          // Close search when clicking outside
          document.addEventListener('click', function(event) {
              if (!searchToggle.contains(event.target) && !searchExpanded.contains(event.target)) {
                  searchExpanded.classList.remove('scale-100');
                  searchExpanded.classList.add('scale-0');
              }
          });
      }
  });

  // Live Chat functionality
  const chatToggle = document.getElementById('chat-toggle');
  const chatWindow = document.getElementById('chat-window');
  const chatClose = document.getElementById('chat-close');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  const chatMessages = document.getElementById('chat-messages');

  function toggleChat() {
      chatWindow.classList.toggle('scale-0');
  }

  chatToggle?.addEventListener('click', toggleChat);
  chatClose?.addEventListener('click', toggleChat);

  function sendMessage() {
      const message = chatInput.value.trim();
      if (message) {
          const userMsg = document.createElement('div');
          userMsg.className = 'mb-3 flex justify-end';
          userMsg.innerHTML = `
              <div class="bg-accent text-white p-3 rounded-lg max-w-xs">
                  <p class="text-sm">${message}</p>
              </div>
          `;
          chatMessages.appendChild(userMsg);
          chatInput.value = '';
          chatMessages.scrollTop = chatMessages.scrollHeight;

          setTimeout(() => {
              const agentMsg = document.createElement('div');
              agentMsg.className = 'mb-3';
              agentMsg.innerHTML = `
                  <div class="bg-primary-50 p-3 rounded-lg max-w-xs">
                      <p class="text-sm">Thank you for your message! Our team will get back to you soon. How else can I help you today?</p>
                      <span class="text-xs text-text-secondary">Support Agent • Online</span>
                  </div>
              `;
              chatMessages.appendChild(agentMsg);
              chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 1500);
      }
  }

  chatSend?.addEventListener('click', sendMessage);
  chatInput?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
          sendMessage();
      }
  });

  // Initialize cart and pricing (hydrate from localStorage)
  const LS_KEY = 'illusionix_cart';
  let cartData = { items: [], services: [], discounts: [], delivery: { type: 'standard', cost: 0 } };

  function readCartFromStorage(){
      try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : {items:[]}; } catch(_) { return {items:[]}; }
  }
  function writeCartToStorage(){
      try {
          const payload = { items: cartData.items.map(i=>({id: i.id, name: i.name, price: i.price, image: i.image || '', qty: i.quantity})) };
          localStorage.setItem(LS_KEY, JSON.stringify(payload));
      } catch(_) {}
  }
  function cartCount(){ return cartData.items.reduce((s,i)=>s + (Number(i.quantity)||0), 0); }
  function updateCartBadge(){ document.querySelectorAll('#cart-count,[data-cart-count]').forEach(el=> el.textContent = String(cartCount())); }

  function cartItemCard(item){
      const total = (Number(item.price||0) * Number(item.quantity||0)).toFixed(2);
      const img = item.image || 'https://images.unsplash.com/photo-1593508512255-86ab42a8e620?q=80&w=1080&auto=format&fit=crop';
      return `
      <div class="card" data-product-id="${item.id}">
        <div class="flex flex-col md:flex-row gap-6">
          <div class="relative w-full md:w-32 h-32 bg-gradient-to-br from-secondary-100 to-secondary-200 rounded-xl overflow-hidden">
            <img src="${img}" alt="${item.name}" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300" loading="lazy" onerror="this.src='https://images.pixabay.com/photo/2017/05/13/12/40/fashion-2309519_1280.jpg'; this.onerror=null;" />
          </div>
          <div class="flex-1">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-lg font-semibold text-primary mb-1">${item.name}</h3>
                <div class="flex items-center space-x-4 text-sm">
                  <span class="text-success font-medium">✓ In Stock</span>
                  <span class="text-text-secondary">SKU: ${item.id}</span>
                </div>
              </div>
              <button class="remove-item text-text-secondary hover:text-error transition-colors" data-product-id="${item.id}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <span class="text-sm text-text-secondary">Qty:</span>
                <div class="flex items-center border border-primary-200 rounded-lg">
                  <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="decrease" data-product-id="${item.id}">-</button>
                  <span class="quantity-display px-3 py-1 border-x border-primary-200">${item.quantity}</span>
                  <button class="quantity-btn px-3 py-1 text-text-secondary hover:text-primary" data-action="increase" data-product-id="${item.id}">+</button>
                </div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-primary item-total">$${total}</div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  function renderCartItems(){
      const container = document.getElementById('cart-items');
      if (!container) return;
      if (!cartData.items.length){
          container.innerHTML = '<div class="text-center py-12"><p class="text-text-secondary text-lg">Your cart is empty</p></div>';
      } else {
          container.innerHTML = cartData.items.map(cartItemCard).join('');
      }
      initializeCart();
      initializeQuantityControls();
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
      // Hydrate from localStorage -> in-memory cart -> DOM
      const stored = readCartFromStorage();
      cartData.items = (stored.items||[]).map(it=>({ id: String(it.id), name: it.name, price: Number(it.price||0), quantity: Number(it.qty||it.quantity||1), image: it.image||'' }));
      renderCartItems();
      initializePaymentModal();
      initializeServices();
      initializePromoCode();
      updateCartTotals();
      updateCartBadge();
  });

  // Initialize cart functionality
  function initializeCart() {
      // Remove item functionality
      document.querySelectorAll('.remove-item').forEach(btn => {
          btn.addEventListener('click', function() {
              const productId = this.dataset.productId;
              removeFromCart(productId);
          });
      });

      // Clear cart
      document.getElementById('clear-cart')?.addEventListener('click', function() {
          if (confirm('Are you sure you want to clear your entire cart?')) {
              clearCart();
          }
      });

      // Add to cart from recommendations
      document.querySelectorAll('.add-to-cart').forEach(btn => {
          btn.addEventListener('click', function(e) {
              e.preventDefault();
              const productData = JSON.parse(this.dataset.product);
              addToCart(productData);
          });
      });
  }

  // Quantity controls
  function initializeQuantityControls() {
      document.querySelectorAll('.quantity-btn').forEach(btn => {
          btn.addEventListener('click', function() {
              const action = this.dataset.action;
              const productId = this.dataset.productId;
              updateQuantity(productId, action);
          });
      });
  }

  // Update quantity
  function updateQuantity(productId, action) {
      const item = cartData.items.find(item => item.id === productId);
      if (!item) return;

      if (action === 'increase') {
          item.quantity++;
      } else if (action === 'decrease' && item.quantity > 1) {
          item.quantity--;
      }

      // Update display
      const cartItem = document.querySelector(`[data-product-id="${productId}"]`);
      const quantityDisplay = cartItem.querySelector('.quantity-display');
      const itemTotal = cartItem.querySelector('.item-total');

      quantityDisplay.textContent = item.quantity;
      itemTotal.textContent = `$${(item.price * item.quantity).toFixed(2)}`;

      writeCartToStorage();
      updateCartTotals();
      updateCartBadge();
      showNotification(`Quantity updated for ${item.name}`, 'info');
  }

  // Remove from cart
  function removeFromCart(productId) {
      const itemIndex = cartData.items.findIndex(item => item.id === productId);
      if (itemIndex > -1) {
          const removedItem = cartData.items.splice(itemIndex, 1)[0];
          document.querySelector(`[data-product-id="${productId}"]`)?.remove();
          writeCartToStorage();
          renderCartItems();
          updateCartTotals();
          updateCartBadge();
          showNotification(`${removedItem.name} removed from cart`, 'info');
      }
  }

  // Add to cart
  function addToCart(product) {
      cartData.items.push({
          id: product.id,
          name: product.name,
          price: product.price,
          quantity: 1
      });
      writeCartToStorage();
      renderCartItems();
      updateCartTotals();
      updateCartBadge();
      showNotification(`${product.name} added to cart!`, 'success');
  }

  // Clear cart
  function clearCart() {
      cartData.items = [];
      cartData.services = [];
      cartData.discounts = [];
      writeCartToStorage();
      renderCartItems();
      updateCartTotals();
      updateCartBadge();
      showNotification('Cart cleared', 'info');
  }

  // Initialize services
  function initializeServices() {
      document.querySelectorAll('.service-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
              const price = parseFloat(this.dataset.price);
              const serviceName = this.closest('label').querySelector('span').textContent;

              if (this.checked) {
                  cartData.services.push({ name: serviceName, price: price });
              } else {
                  cartData.services = cartData.services.filter(service => service.name !== serviceName);
              }

              updateCartTotals();
          });
      });
  }

  // Initialize promo code
  function initializePromoCode() {
      document.getElementById('apply-promo')?.addEventListener('click', function() {
          const promoCode = document.getElementById('promo-code').value.trim().toUpperCase();
          applyPromoCode(promoCode);
      });
  }

  // Apply promo code
  function applyPromoCode(code) {
      const promoCodes = {
          'NEWUSER': { type: 'percentage', value: 0.1, description: '10% off your order' },
          'VR2025': { type: 'fixed', value: 25, description: '$25 off + free shipping' },
          'WELCOME': { type: 'percentage', value: 0.05, description: '5% off for new customers' }
      };

      if (promoCodes[code]) {
          // Check if already applied
          if (cartData.discounts.find(d => d.code === code)) {
              showNotification('Promo code already applied', 'warning');
              return;
          }

          const promo = promoCodes[code];
          cartData.discounts.push({
              code: code,
              ...promo
          });

          updateCartTotals();
          showNotification(`Promo code applied: ${promo.description}`, 'success');
          document.getElementById('promo-code').value = '';
      } else {
          showNotification('Invalid promo code', 'warning');
      }
  }

  // Update cart totals
  function updateCartTotals() {
      let subtotal = cartData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const itemsCount = cartCount();
      let servicesTotal = cartData.services.reduce((sum, service) => sum + service.price, 0);

      let discountAmount = 0;
      cartData.discounts.forEach(discount => {
          if (discount.type === 'percentage') {
              discountAmount += subtotal * discount.value;
          } else {
              discountAmount += discount.value;
          }
      });

      let tax = (subtotal + servicesTotal - discountAmount) * 0.08; // 8% tax
      let total = subtotal + servicesTotal + cartData.delivery.cost + tax - discountAmount;

      // Update display
      document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
      const label = document.getElementById('subtotal-label'); if (label) label.textContent = `Subtotal (${itemsCount} item${itemsCount===1?'':'s'})`;
      document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
      document.getElementById('discount').textContent = discountAmount > 0 ? `-$${discountAmount.toFixed(2)}` : '$0.00';
      document.getElementById('total').textContent = `$${total.toFixed(2)}`;

      // Update checkout button
      document.getElementById('checkout-btn').innerHTML = `
          Proceed to Secure Checkout
          <svg class="w-5 h-5 ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
      `;
  }

  // Initialize payment modal
  function initializePaymentModal() {
      const checkoutBtn = document.getElementById('checkout-btn');
      const paymentModal = document.getElementById('payment-modal');
      const closeModalBtn = document.getElementById('close-payment-modal');
      const placeOrderBtn = document.getElementById('place-order-btn');

      checkoutBtn?.addEventListener('click', function() {
          paymentModal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
      });

      closeModalBtn?.addEventListener('click', function() {
          paymentModal.classList.add('hidden');
          document.body.style.overflow = 'auto';
      });

      // Payment method tabs
      document.querySelectorAll('.payment-tab').forEach(tab => {
          tab.addEventListener('click', function() {
              const method = this.dataset.method;
              switchPaymentMethod(method);
          });
      });

      // Place order
      placeOrderBtn?.addEventListener('click', function() {
          placeOrder();
      });

      // Card number formatting
      document.getElementById('card-number')?.addEventListener('input', function() {
          let value = this.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
          let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
          this.value = formattedValue;
      });

      // Expiry date formatting
      document.getElementById('expiry')?.addEventListener('input', function() {
          let value = this.value.replace(/\D/g, '');
          if (value.length >= 2) {
              value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          this.value = value;
      });
  }

  // Switch payment method
  function switchPaymentMethod(method) {
      // Update tabs
      document.querySelectorAll('.payment-tab').forEach(tab => {
          tab.classList.remove('active', 'border-accent', 'bg-accent-50', 'text-accent');
          tab.classList.add('border-primary-200', 'text-text-secondary');
      });

      document.querySelector(`[data-method="${method}"]`).classList.add('active', 'border-accent', 'bg-accent-50', 'text-accent');
      document.querySelector(`[data-method="${method}"]`).classList.remove('border-primary-200', 'text-text-secondary');

      // Show/hide forms
      document.querySelectorAll('.payment-form').forEach(form => {
          form.classList.add('hidden');
      });

      document.getElementById(`${method}-form`).classList.remove('hidden');
  }

  // Place order
  async function placeOrder() {
      const requiredFields = ['first-name', 'last-name', 'email', 'phone', 'address', 'city', 'zip', 'state'];
      let valid = true;
      requiredFields.forEach(field => {
          const input = document.getElementById(field);
          if (!input || !input.value.trim()) {
              if (input) input.classList.add('border-error');
              valid = false;
          } else {
              input.classList.remove('border-error');
          }
      });
      if (!valid) { showNotification('Please fill in all required fields', 'warning'); return; }

      const btn = document.getElementById('place-order-btn');
      btn.innerHTML = 'Processing Order...';
      btn.disabled = true;
      try {
          // Ensure server-side cart is in sync with client before placing order
          try {
              const items = Array.isArray(cartData.items) ? cartData.items : [];
              for (const it of items) {
                  const sku = String(it.id||'');
                  const qty = String(it.quantity||1);
                  if (!sku) continue;
                  await fetch('/cart/add', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({ sku, qty, name: it.name||'', price: String(it.price||0), image: it.image||'' }) });
              }
          } catch(_) { /* best-effort */ }
          // Prepare lightweight payload as a fallback if server-side cart is empty
          const payload = {
              userName: document.getElementById('cardholder-name')?.value || undefined,
              userEmail: document.querySelector('input[type="email"]')?.value || undefined,
              items: (cartData.items||[]).map(it=>({ id: String(it.id), name: it.name, price: Number(it.price||0), qty: Number(it.quantity||1), image: it.image||'' }))
          };
          const res = await fetch('/order/place', {
              method: 'POST',
              headers: { 'X-XSRF-TOKEN': xsrf(), 'Accept':'application/json', 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
          });
          if (!res.ok) {
              // Try to parse JSON to show a more helpful message
              let detailText = '';
              try { const j = await res.json(); detailText = j && j.message ? String(j.message) : ''; } catch(_){ try{ detailText = await res.text(); }catch(_){ detailText=''; } }
              const msg = detailText && detailText.length > 0 ? detailText : 'Unable to place order right now';
              throw new Error(msg);
          }
          let data = {};
          try { data = await res.json(); } catch(_) { data = {}; }
          const numEl = document.getElementById('order-number'); if (numEl) numEl.textContent = data.orderNumber || '#ORDER';
          // Clear local cart and refresh UI for consistency with server-cleared cart
          try {
              cartData.items = [];
              writeCartToStorage();
              renderCartItems();
              updateCartTotals();
              updateCartBadge();
          } catch(_) {}
          document.getElementById('payment-modal').classList.add('hidden');
          document.getElementById('confirmation-modal').classList.remove('hidden');
          showNotification('Order placed successfully! Confirmation email sent.', 'success');
      } catch (e) {
          try { console.error('placeOrder failed:', e); } catch(_) {}
          const msg = (e && e.message) ? String(e.message) : 'Could not place order. Please try again.';
          showNotification(msg, 'warning');
      } finally {
          btn.innerHTML = 'Place Order - $892.08';
          btn.disabled = false;
      }
  }

  // Notification system
  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white transform translate-x-full transition-transform duration-300 ${
          type === 'success' ? 'bg-success' :
          type === 'error' ? 'bg-error' :
          type === 'warning' ? 'bg-warning' : 'bg-accent'
      }`;
      notification.innerHTML = `
          <div class="flex items-center">
              <span class="mr-2">${message}</span>
              <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
              </button>
          </div>
      `;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
          notification.style.transform = 'translateX(0)';
      }, 100);

      // Auto remove after 5 seconds
      setTimeout(() => {
          notification.style.transform = 'translateX(full)';
          setTimeout(() => notification.remove(), 300);
      }, 5000);
  }

  // Theme toggle (light/dark) consistent with other pages
  (function(){
    const KEY='illusionix-theme', DARK='theme-dark';
    function apply(t){ const r=document.documentElement; if(t==='dark') r.classList.add(DARK); else r.classList.remove(DARK); }
    function get(){ try{return localStorage.getItem(KEY)||'light';}catch(_){return 'light';} }
    function set(t){ try{localStorage.setItem(KEY,t);}catch(_){}}
    function current(){ return document.documentElement.classList.contains(DARK)?'dark':'light'; }
    function reflect(){ const t=current(); document.querySelectorAll('.theme-toggle [data-icon="sun"]').forEach(e=>e.style.display=t==='dark'?'inline-block':'none'); document.querySelectorAll('.theme-toggle [data-icon="moon"]').forEach(e=>e.style.display=t==='dark'?'none':'inline-block'); document.querySelectorAll('.theme-toggle').forEach(b=>{ b.setAttribute('aria-pressed', t==='dark'?'true':'false'); b.setAttribute('title', t==='dark'?'Switch to light mode':'Switch to dark mode'); }); }
    // initial
    apply(get()); reflect();
    // bind
    document.querySelectorAll('.theme-toggle').forEach(btn=> btn.addEventListener('click', function(){ const next=current()==='dark'?'light':'dark'; apply(next); set(next); reflect(); }));
  })();
</script>

<style>
  .card {
      transition: all 0.3s ease;
  }

  .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .payment-tab.active {
      border-color: #f59e0b !important;
      background-color: #fef3c7 !important;
      color: #f59e0b !important;
  }

  .border-error {
      border-color: #ef4444 !important;
  }

  /* Smooth scrolling */
  html {
      scroll-behavior: smooth;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
      width: 8px;
  }

  ::-webkit-scrollbar-track {
      background: #f1f5f9;
  }

  ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
  }
</style>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>
